{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Upload Document</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="upload-form">
                    <div class="mb-3">
                        <label for="file" class="form-label">Choose File</label>
                        <input type="file" class="form-control" id="file" name="file" required>
                        <div class="form-text">
                            Supported formats: PDF, EPUB, TXT, MOBI, AZW, AZW3<br>
                            Max size: 20MB
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject</label>
                        <select class="form-select" id="subject" name="subject">
                            <option value="general">General</option>
                            <option value="finance">Finance</option>
                            <option value="ai">AI</option>
                            <option value="history">History</option>
                            <option value="science">Science</option>
                            <option value="technology">Technology</option>
                            <option value="education">Education</option>
                            <option value="business">Business</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="tags" class="form-label">Tags (comma-separated)</label>
                        <input type="text" class="form-control" id="tags" name="tags" placeholder="investing, basics, retirement">
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-cloud-upload-alt me-2"></i>Upload and Process
                    </button>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Instructions</h5>
            </div>
            <div class="card-body">
                <p>
                    <strong>1. Upload a document</strong> - Choose from various formats like PDF, EPUB, or TXT.
                </p>
                <p>
                    <strong>2. Ask questions</strong> - Chat with the AI about the content of your document.
                </p>
                <p>
                    <strong>3. Explore topics</strong> - Click on suggested follow-up questions or keywords to dive deeper.
                </p>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card chat-container">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Chat</h5>
            </div>
            <div class="card-body chat-history" id="chat-history">
                <div class="welcome-message">
                    <h4>Welcome to AI Document Chat!</h4>
                    <p>
                        I'm here to help you understand your documents better. Upload a document on the left, then ask me questions about its content.
                    </p>
                    <p>
                        I'll use my knowledge to provide informative, witty responses with helpful analogies and metaphors to make complex topics easier to understand.
                    </p>
                    <p>
                        <strong>Try uploading a document to get started!</strong>
                    </p>
                </div>
            </div>
            <div class="card-footer">
                <form id="chat-form" class="d-flex">
                    <input type="text" class="form-control me-2" id="user-message" placeholder="Ask a question about your document...">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatForm = document.getElementById('chat-form');
        const chatHistory = document.getElementById('chat-history');
        const userMessage = document.getElementById('user-message');

        // Handle chat form submission
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = userMessage.value.trim();
            if (!message) return;
            
            // Add user message to chat
            appendMessage('user', message);
            
            // Clear input
            userMessage.value = '';
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'message ai-message typing-indicator';
            typingIndicator.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
            chatHistory.appendChild(typingIndicator);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // Send message to backend
            fetch('/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: message
                }),
            })
            .then(response => response.json())
            .then(data => {
                // Remove typing indicator
                chatHistory.removeChild(typingIndicator);
                
                // Add AI response to chat
                appendMessage('ai', data.answer, data.keywords, data.follow_up_questions);
            })
            .catch(error => {
                // Remove typing indicator
                chatHistory.removeChild(typingIndicator);
                
                // Show error message
                appendMessage('ai', `<p>Sorry, an error occurred: ${error.message}</p>`);
            });
        });
        
        // Function to append a message to the chat
        function appendMessage(sender, content, keywords = [], followUpQuestions = []) {
            // Create message element
            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender}-message`;
            
            // Add user icon or AI icon
            const iconClass = sender === 'user' ? 'fa-user' : 'fa-robot';
            const iconColor = sender === 'user' ? 'text-primary' : 'text-success';
            
            messageElement.innerHTML = `
                <div class="message-icon">
                    <i class="fas ${iconClass} ${iconColor}"></i>
                </div>
                <div class="message-content">
                    ${content}
                </div>
            `;
            
            // Add to chat history
            chatHistory.appendChild(messageElement);
            
            // Scroll to bottom
            chatHistory.scrollTop = chatHistory.scrollHeight;
            
            // Set up event listeners for keyword buttons and follow-up questions
            if (sender === 'ai') {
                setupButtonEventListeners();
            }
        }
        
        // Function to set up event listeners for interactive elements
        function setupButtonEventListeners() {
            // Add event listeners to keyword buttons
            document.querySelectorAll('.keyword').forEach(button => {
                button.addEventListener('click', function() {
                    const keyword = this.textContent;
                    userMessage.value = `Tell me more about ${keyword}`;
                    userMessage.focus();
                });
            });
            
            // Add event listeners to follow-up question buttons
            document.querySelectorAll('.follow-up-question').forEach(button => {
                button.addEventListener('click', function() {
                    const question = this.textContent;
                    userMessage.value = question;
                    chatForm.dispatchEvent(new Event('submit'));
                });
            });
        }
        
        // Initialize the UI
        setupButtonEventListeners();
    });
</script>
{% endblock %}
